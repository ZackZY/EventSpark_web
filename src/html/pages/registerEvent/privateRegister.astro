---
import { apiUrlHelper } from "../../../utils/api.config";
import Head from "@components/_head.astro";
import Footer from "@components/dashboard/_footer.astro";
import Topbar from "@components/dashboard/_topbar.astro";
import Sidenav from "@components/dashboard/_sidenav.astro";
import Scripts from "@components/_scripts.astro";

const title = "Private Event Register Form";
const path = "../../../dist";
const mainPage = "privateRegister";
const page = "privateRegister";
---

<!DOCTYPE html>
<html lang="en">
<head>
    <Head title={title} path={path} />
</head>
<body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <div class="app-wrapper">
        <Topbar path={path} />
        <Sidenav path={path} mainPage={mainPage} page={page} />
        <main class="app-main">
            <div class="app-content-header">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="mb-0">Registration Event Form</h3>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-end">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active">Event Registration</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <div class="app-content">
                <div class="container-fluid">
                    <div class="row g-4">
                        <div class="col-md-10">
                            <div id="eventInfo" class="alert alert-info mb-4">
                                Loading event details...
                            </div>

                            <div id="eventDetails" class="card mb-4" style="display: none;">
                                <div class="card-header">
                                    <h5 class="card-title" id="eventName">Event Name</h5>
                                </div>
                                <div class="card-body">
                                    <p>Description: <span id="eventDescription"></span></p>
                                    <p>Date: <span id="eventDate"></span></p>
                                    <p>Location: <span id="eventLocation"></span></p>
                                    <p>Start Time: <span id="eventStartTime"></span></p>
                                    <p>End Time: <span id="eventEndTime"></span></p>
                                </div>
                            </div>

                            <div class="card card-info card-outline mb-20">
                                <div class="card-header">
                                    <div class="card-title">Registration Form</div>
                                </div>
                                <form class="needs-validation" novalidate id="submitform">
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <input type="hidden" id="attendeeId" value="" />
                                            <div class="col-md-6">
                                                <label class="form-label">Attendee ID</label>
                                                <input type="text" class="form-control" id="attendeeIdDisplay" readonly />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Name</label>
                                                <input type="text" class="form-control" id="validationName" required />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Email Address</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">@</span>
                                                    <input type="email" class="form-control" id="validationEmail" required />
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Contact Number</label>
                                                <input type="tel" class="form-control" id="validationContact" required />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-info" type="submit">Register for Event</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <Footer />
    </div>
    <Scripts path={path} />

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const url = new URL(window.location.href);
        const eventHash = url.searchParams.get('eventhash');

        if (eventHash && eventHash.length === 73) { // Ensure it has exactly 36 + 36 + 1 characters
            // Extract eventId and attendeeId based on fixed lengths
            const eventId = eventHash.substring(0, 36);
            const attendeeId = eventHash.substring(37, 73);
            document.getElementById("attendeeId").value = attendeeId;
            document.getElementById("attendeeIdDisplay").value = attendeeId;
            
            console.log("Event ID:", eventId);
            console.log("Attendee ID:", attendeeId);

            // Fetch event and attendee data
            try {
                const eventDetails = await fetchFromApi(apiUrlHelper.EventsAPI + "/" + eventId, "GET");
                const attendeeData = await fetchFromApi(apiUrlHelper.UsersAPI + "/" + attendeeId, "GET");

                // Populate event details
                document.getElementById("eventName").textContent = eventDetails.eventName;
                document.getElementById("eventDescription").textContent = eventDetails.eventDescription;
                document.getElementById("eventDate").textContent = eventDetails.eventDate;
                document.getElementById("eventLocation").textContent = eventDetails.eventLocation;
                document.getElementById("eventStartTime").textContent = eventDetails.eventTimeStart;
                document.getElementById("eventEndTime").textContent = eventDetails.eventTimeEnd;
                document.getElementById("eventInfo").style.display = "none";
                document.getElementById("eventDetails").style.display = "block";

                // Populate attendee data
                document.getElementById("validationName").value = attendeeData.name || '';
                document.getElementById("validationEmail").value = attendeeData.email || '';
                document.getElementById("validationContact").value = attendeeData.contactNumber || '';

            } catch (error) {
                console.error("Error fetching event or attendee data:", error);
                document.getElementById("eventInfo").textContent = "Failed to load event details.";
            }
        } else {
            document.getElementById("eventInfo").textContent = "The 'eventhash' parameter is missing or invalid in the URL.";
        }

        // Form submission handler
        const form = document.getElementById("submitform");
        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            if (!form.checkValidity()) {
                form.classList.add("was-validated");
                return;
            }

            const formData = {
                attendeeId: document.getElementById("attendeeId").value,
                name: document.getElementById("validationName").value,
                email: document.getElementById("validationEmail").value,
                contactNumber: document.getElementById("validationContact").value,
            };

            try {
                const response = await fetch(`/api/users/${formData.attendeeId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData),
                });

                const result = await response.json();
                if (response.ok) {
                    alert('Registration successful!');
                    setTimeout(() => {
                        window.location.href = "http://localhost:3000/index.html";
                    }, 2000);
                } else {
                    throw new Error(result.message || 'Registration failed');
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                alert('Registration failed. Please try again.');
            }
        });
      });
    </script>
</body>
</html>
